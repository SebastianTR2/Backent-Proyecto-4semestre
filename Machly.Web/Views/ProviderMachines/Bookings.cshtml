@using Machly.Web.Models
@model List<BookingDetailDto>
@{
    ViewData["Title"] = "Reservas";
    var scope = (ViewData["Scope"]?.ToString() ?? "month").ToLowerInvariant();
    var from = ViewData["From"]?.ToString();
    var to = ViewData["To"]?.ToString();
    string FilterButtonClass(string value) => scope == value ? "btn btn-primary btn-sm" : "btn btn-outline-secondary btn-sm";
}

<div class="page-header">
    <div>
        <h1 class="page-title">Reservas de mis máquinas</h1>
        <p class="page-subtitle">Controla las reservas activas y completadas</p>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
            <span class="text-muted me-2">Rango rápido:</span>
            <a asp-action="Bookings" asp-route-scope="today" class="@FilterButtonClass("today")">Hoy</a>
            <a asp-action="Bookings" asp-route-scope="week" class="@FilterButtonClass("week")">Semana</a>
            <a asp-action="Bookings" asp-route-scope="month" class="@FilterButtonClass("month")">Mes</a>
            <a asp-action="Bookings" asp-route-scope="3m" class="@FilterButtonClass("3m")">3 meses</a>
            <a asp-action="Bookings" asp-route-scope="6m" class="@FilterButtonClass("6m")">6 meses</a>
            <a asp-action="Bookings" asp-route-scope="year" class="@FilterButtonClass("year")">1 año</a>
        </div>
        <form asp-action="Bookings" method="get" class="row g-3 align-items-end">
            <input type="hidden" name="scope" value="custom" />
            <div class="col-md-4">
                <label class="form-label">Desde</label>
                <input type="date" name="from" value="@from" class="form-control" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Hasta</label>
                <input type="date" name="to" value="@to" class="form-control" />
            </div>
            <div class="col-md-4 d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1">
                    <i class="fas fa-filter me-2"></i>Filtrar
                </button>
                <a asp-action="Bookings" class="btn btn-outline-secondary">Limpiar</a>
            </div>
        </form>
    </div>
</div>

@if (Model.Any())
{
    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Máquina</th>
                        <th>Cliente</th>
                        <th>Inicio</th>
                        <th>Fin</th>
                        <th>Estado</th>
                        <th>Total</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var booking in Model)
                    {
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    @if (!string.IsNullOrEmpty(booking.MachinePhotoUrl))
                                    {
                                        <img src="@booking.MachinePhotoUrl" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;" />
                                    }
                                    <div>
                                        <div class="fw-bold">@booking.MachineTitle</div>
                                        <small class="text-muted">ID: @booking.MachineId.Substring(booking.MachineId.Length - 6)</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <div class="fw-bold">@booking.RenterName</div>
                                    <small class="text-muted">@booking.RenterEmail</small>
                                </div>
                            </td>
                            <td>@booking.Start.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@booking.End.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                            <td>
                                <span class="badge bg-@(booking.Status == "CONFIRMED" ? "success" : booking.Status == "COMPLETED" ? "info" : "warning text-dark")">
                                    @booking.Status
                                </span>
                            </td>
                            <td>Bs. @booking.TotalPrice.ToString("N2")</td>
                            <td class="text-end">
                                @if (booking.Status == "CONFIRMED" && booking.CheckInDate == null)
                                {
                                    <button class="btn btn-sm btn-outline-primary" onclick="checkIn('@booking.Id')">Check-in</button>
                                }
                                @if (booking.Status == "IN_PROGRESS" && booking.CheckOutDate == null)
                                {
                                    <button class="btn btn-sm btn-outline-success" onclick="checkOut('@booking.Id')">Check-out</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
else
{
    <div class="alert alert-info">No hay reservas para tus máquinas.</div>
}

@section Scripts {
    <script>
        function checkIn(bookingId) {
            if (confirm('¿Realizar check-in?')) {
                window.location.href = '@Url.Action("CheckIn", "ProviderMachines")?bookingId=' + bookingId;
            }
        }

        function checkOut(bookingId) {
            if (confirm('¿Realizar check-out?')) {
                window.location.href = '@Url.Action("CheckOut", "ProviderMachines")?bookingId=' + bookingId;
            }
        }
    </script>
}

