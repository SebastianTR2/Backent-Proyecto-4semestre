@{
    ViewData["Title"] = "Mapa Global de Máquinas";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid p-0">
    <div id="map" style="height: calc(100vh - 56px); width: 100%;"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var map = L.map('map').setView([-16.5000, -68.1500], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Cargar todas las máquinas
            fetch('/Admin/GetAllMachinesGeo')
                .then(response => response.json())
                .then(data => {
                    data.forEach(machine => {
                        if (machine.lat && machine.lng) {
                            var color = machine.type === 'AGRICOLA' ? 'green' : 'blue';
                            
                            // Icono personalizado simple
                            var icon = L.divIcon({
                                className: 'custom-div-icon',
                                html: `<div style='background-color:${color}; width: 10px; height: 10px; border-radius: 50%; border: 1px solid white;'></div>`,
                                iconSize: [10, 10],
                                iconAnchor: [5, 5]
                            });

                            var marker = L.marker([machine.lat, machine.lng], { icon: icon }).addTo(map);
                            
                            var popupContent = `
                                <div>
                                    <strong>${machine.title}</strong><br>
                                    <span class="badge bg-${machine.type === 'AGRICOLA' ? 'success' : 'primary'}">${machine.type}</span>
                                    <br>Prov: ${machine.providerId}
                                </div>
                            `;
                            marker.bindPopup(popupContent);
                        }
                    });
                });
        });
    </script>
}
