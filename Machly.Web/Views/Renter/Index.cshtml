@using Machly.Web.Models
@model List<BookingDetailDto>
@{
    ViewData["Title"] = "Mis Reservas";
    var scope = (ViewData["Scope"]?.ToString() ?? "month").ToLowerInvariant();
    var from = ViewData["From"]?.ToString();
    var to = ViewData["To"]?.ToString();
    string FilterButtonClass(string value) => scope == value ? "btn btn-primary btn-sm" : "btn btn-outline-secondary btn-sm";
}

<div class="page-header">
    <div>
        <h1 class="page-title">Mis reservas</h1>
        <p class="page-subtitle">Consulta y controla tus reservas activas y pasadas</p>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
            <span class="text-muted me-2">Rango r치pido:</span>
            <a asp-action="Index" asp-route-scope="today" class="@FilterButtonClass("today")">Hoy</a>
            <a asp-action="Index" asp-route-scope="week" class="@FilterButtonClass("week")">Semana</a>
            <a asp-action="Index" asp-route-scope="month" class="@FilterButtonClass("month")">Mes</a>
            <a asp-action="Index" asp-route-scope="3m" class="@FilterButtonClass("3m")">3 meses</a>
            <a asp-action="Index" asp-route-scope="6m" class="@FilterButtonClass("6m")">6 meses</a>
            <a asp-action="Index" asp-route-scope="year" class="@FilterButtonClass("year")">1 a침o</a>
        </div>
        <form asp-action="Index" method="get" class="row g-3 align-items-end">
            <input type="hidden" name="scope" value="custom" />
            <div class="col-md-4">
                <label class="form-label">Desde</label>
                <input type="date" name="from" value="@from" class="form-control" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Hasta</label>
                <input type="date" name="to" value="@to" class="form-control" />
            </div>
            <div class="col-md-4 d-flex gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1">
                    <i class="fas fa-filter me-2"></i>Filtrar
                </button>
                <a asp-action="Index" class="btn btn-outline-secondary">Limpiar</a>
            </div>
        </form>
    </div>
</div>

@if (Model.Any())
{
    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>M치quina</th>
                        <th>Inicio</th>
                        <th>Fin</th>
                        <th>Estado</th>
                        <th>Total</th>
                        <th class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var booking in Model)
                    {
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    @if (!string.IsNullOrEmpty(booking.MachinePhotoUrl))
                                    {
                                        <img src="@booking.MachinePhotoUrl" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;" />
                                    }
                                    <div>
                                        <div class="fw-bold">@booking.MachineTitle</div>
                                        <small class="text-muted">ID: @booking.MachineId.Substring(booking.MachineId.Length - 6)</small>
                                    </div>
                                </div>
                            </td>
                            <td>@booking.Start.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@booking.End.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                            <td>
                                <span class="badge bg-@(booking.Status == "CONFIRMED" ? "success" : booking.Status == "COMPLETED" ? "info" : "warning text-dark")">
                                    @booking.Status
                                </span>
                            </td>
                            <td>Bs. @booking.TotalPrice.ToString("N2")</td>
                            <td class="text-end">
                                @if (booking.Status == "COMPLETED" && booking.Review == null)
                                {
                                    <button class="btn btn-sm btn-outline-primary" onclick="showReviewModal('@booking.Id')">Calificar</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
else
{
    <div class="alert alert-info">No tienes reservas en el rango seleccionado.</div>
}

<!-- Modal para Review -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Calificar Reserva</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="reviewForm" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Calificaci칩n (1-5)</label>
                        <input type="number" name="rating" class="form-control" min="1" max="5" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Comentario</label>
                        <textarea name="comment" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Enviar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showReviewModal(bookingId) {
            const form = document.getElementById('reviewForm');
            form.action = '@Url.Action("AddReview", "Renter")?bookingId=' + bookingId;
            const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
            modal.show();
        }
    </script>
}

