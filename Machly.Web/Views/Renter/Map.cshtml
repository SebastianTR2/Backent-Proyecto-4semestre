@{
    ViewData["Title"] = "Mapa de Máquinas";
}

<div class="container-fluid p-0">
    <div id="map" style="height: calc(100vh - 56px); width: 100%;"></div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

@section Scripts {
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar mapa (centrado en Bolivia por defecto)
            var map = L.map('map').setView([-16.5000, -68.1500], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Obtener ubicación del usuario
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    map.setView([lat, lng], 12);
                    loadMachines(lat, lng);
                }, function () {
                    // Si falla, cargar con centro por defecto
                    loadMachines(-16.5000, -68.1500);
                });
            } else {
                loadMachines(-16.5000, -68.1500);
            }

            function loadMachines(lat, lng) {
                // Llamar a la API (usando el cliente web que a su vez llama a la API)
                // Nota: Aquí llamamos directamente a la API o a una acción del controlador que haga de proxy.
                // Para simplificar, asumiremos que RenterController tiene una acción GetNearMachines que devuelve JSON.
                
                fetch(`/Renter/GetNearMachines?lat=${lat}&lng=${lng}&radiusKm=100`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(machine => {
                            if (machine.lat && machine.lng) {
                                var marker = L.marker([machine.lat, machine.lng]).addTo(map);
                                
                                var popupContent = `
                                    <div class="card border-0" style="width: 200px;">
                                        <img src="${machine.photos && machine.photos.length > 0 ? machine.photos[0].url : '/img/placeholder.jpg'}" class="card-img-top" style="height: 120px; object-fit: cover;">
                                        <div class="card-body p-2">
                                            <h6 class="card-title mb-1">${machine.title}</h6>
                                            <p class="card-text small text-muted mb-1">${machine.type}</p>
                                            <p class="fw-bold text-primary mb-2">Bs. ${machine.pricePerDay}/día</p>
                                            <a href="/Renter/Details/${machine.id}" class="btn btn-sm btn-primary w-100">Ver Detalles</a>
                                        </div>
                                    </div>
                                `;
                                
                                marker.bindPopup(popupContent);
                            }
                        });
                    })
                    .catch(error => console.error('Error loading machines:', error));
            }
        });
    </script>
}
