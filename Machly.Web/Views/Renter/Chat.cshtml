@model string 
@{
    ViewData["Title"] = "Chat con Proveedor";
    var providerId = Model; // El modelo es el ID del proveedor
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var token = User.FindFirst("AccessToken")?.Value; // Necesitamos pasar el token JWT al cliente JS
    // Nota: El token JWT normalmente no está en los claims por defecto a menos que lo guardemos ahí al login.
    // Asumiremos que tenemos una forma de obtener el token, o usaremos cookie auth y el hub validará cookie?
    // SignalR con Cookie Auth funciona si están en el mismo dominio.
    // Si API y Web son proyectos separados pero mismo dominio (localhost ports), CORS + Cookies puede ser tricky.
    // Mejor usar Token si es posible.
    // Para este ejemplo, asumiremos que el token se puede obtener o que la cookie fluye.
}

<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            Chat con Proveedor
        </div>
        <div class="card-body" id="chatBox" style="height: 400px; overflow-y: scroll;">
            <!-- Mensajes aquí -->
        </div>
        <div class="card-footer">
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control" placeholder="Escribe un mensaje...">
                <button class="btn btn-primary" id="sendButton">Enviar</button>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="currentUserId" value="@currentUserId" />
<input type="hidden" id="receiverId" value="@providerId" />
<input type="hidden" id="bookingId" value="" /> <!-- Opcional -->

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script src="~/js/chat.js"></script>
    <script>
        // Obtener historial
        var receiverId = document.getElementById('receiverId').value;
        
        fetch(`/Chat/GetHistory?otherUserId=${receiverId}`)
            .then(res => res.json())
            .then(messages => {
                messages.forEach(msg => appendMessage(msg));
                scrollToBottom();
            });

        // Iniciar SignalR
        // Nota: Ajustar URL a la de la API
        var hubUrl = "http://localhost:5000/chatHub"; 
        var chat = new ChatClient(hubUrl, null); // Token null si usamos cookies o si no lo tenemos a mano
        
        chat.onReceiveMessage = (senderId, message, bookingId, timestamp) => {
            appendMessage({ senderId: senderId, message: message, timestamp: timestamp });
            scrollToBottom();
        };
        
        chat.onMessageSent = (msg) => {
            appendMessage(msg);
            scrollToBottom();
        };

        chat.registerHandlers();
        chat.start();

        document.getElementById('sendButton').addEventListener('click', () => {
            var msg = document.getElementById('messageInput').value;
            if (msg) {
                chat.sendMessage(receiverId, msg, null);
                document.getElementById('messageInput').value = '';
            }
        });

        function appendMessage(msg) {
            var currentUserId = document.getElementById('currentUserId').value;
            var isMe = msg.senderId === currentUserId;
            var align = isMe ? 'text-end' : 'text-start';
            var bg = isMe ? 'bg-primary text-white' : 'bg-light';
            
            var html = `
                <div class="${align} mb-2">
                    <div class="d-inline-block p-2 rounded ${bg}" style="max-width: 70%;">
                        ${msg.message}
                    </div>
                    <div class="small text-muted">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                </div>
            `;
            document.getElementById('chatBox').insertAdjacentHTML('beforeend', html);
        }

        function scrollToBottom() {
            var chatBox = document.getElementById('chatBox');
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
}
